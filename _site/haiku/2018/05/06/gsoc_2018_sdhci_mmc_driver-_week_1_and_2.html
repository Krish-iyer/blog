<!DOCTYPE html>
<html lang="en">
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-167285649-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-167285649-1');
</script>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>krish-iyer.github.ioWeek #1 and #2</title><!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v3.8.7" />
<meta property="og:title" content="Week #1 and #2" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Hey folks! here’s the updates of past two weeks on the project!" />
<meta property="og:description" content="Hey folks! here’s the updates of past two weeks on the project!" />
<link rel="canonical" href="http://localhost:4000/haiku/2018/05/06/gsoc_2018_sdhci_mmc_driver-_week_1_and_2.html" />
<meta property="og:url" content="http://localhost:4000/haiku/2018/05/06/gsoc_2018_sdhci_mmc_driver-_week_1_and_2.html" />
<meta property="og:site_name" content="krish-iyer.github.io" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-05-06T12:28:47+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Week #1 and #2" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2018-05-06T12:28:47+00:00","datePublished":"2018-05-06T12:28:47+00:00","description":"Hey folks! here’s the updates of past two weeks on the project!","headline":"Week #1 and #2","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/haiku/2018/05/06/gsoc_2018_sdhci_mmc_driver-_week_1_and_2.html"},"url":"http://localhost:4000/haiku/2018/05/06/gsoc_2018_sdhci_mmc_driver-_week_1_and_2.html"}</script>
<!-- End Jekyll SEO tag -->
<script>
MathJax = {
  tex: {
    inlineMath: [ ['$', '$'], ['\\(', '\\)'] ]
  },
  svg: {
    fontCache: 'global'
  }
};
</script>
<script
  type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
</script>
<link rel="stylesheet" type="text/css" href="/assets/main-light.css"></head>
<body>
    <div class="container"><header>
  <div class="menu">
    <ul><li><a href="/">/home</a></li><li><a href="/assets/Krishnan-Iyer-Resume.pdf" target="_blank" rel="noopener noreferrer">/cv</a></li><li><a href="/about/">/about</a></li><li><a href="/contact">/contact</a></li></ul>
  </div>
</header>
<main>
      <ul>
  <center><h1>Week #1 and #2</h1></center>
  <p style="text-align: center; font-style: italic; font-size: 0.9em;">May 6, 2018</p>
</ul>

<p>Hey folks! here’s the updates of past two weeks on the project!</p>

<p>I have cloned the latest haiku source and built the image file. With the generated image file I have emulated sdhci-pci device successfully. Following are the instructions to be followed:</p>

<h2 id="cloning-the-source-code">Cloning the source code</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/haiku/haiku.git
git clone https://github.com/haiku/buildtools.git
</code></pre></div></div>

<h2 id="compiling-source-code">Compiling Source Code</h2>
<p>Create a directory where you are going to save the build image and related files</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir generated.x86_64; cd generated.x86_64 For compiling

../configure --build-cross-tools x86_64 ../../buildtools
</code></pre></div></div>

<h2 id="building-image">Building Image</h2>
<p>Before building the image you need to install some dependencies</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt-get install git nasm autoconf automake texinfo flex bison gawk build-essential unzip wget zip less zlib1g-dev libcurl4-openssl-dev genisoimage libtool
</code></pre></div></div>

<p>For creating nightly anyboot Haiku iso image</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jam -q -j2 @nightly-anyboot ## Error! while building 
</code></pre></div></div>

<p>Now if you getting an error while building, specifically about haiku revision. Then,</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd haiku/build/jam
cat UserBuildConfig Now copy hrexxxxx, and change directory to haiku/generated.x86_64/build

cd haiku/generated.x86_64/build Then create and write into the file 

echo -n "hrevxxxxx" &gt; haiku-revision After the building and emulation of the device, I have started finding out the device on the PCI bus so that I can add functionalities for data transfer and many more.
</code></pre></div></div>

<h2 id="emulation-with-qemu">Emulation with Qemu</h2>

<h3 id="installing-qemu">Installing Qemu</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt-get install qemu ### Boot OS in Virtual Drive First of all create a virtual harddrive in which you are going to boot the OS

qemu-img create haiku-vm.img 10G Now boot the OS in virtual drive 

sudo qemu-system-x86_64 -boot d -cdrom haiku/generated.x86_64/haiku-nightly-anyboot.iso -m 512 -hda haiku-vm.img
</code></pre></div></div>

<p>Now you can simply run the virtual drive</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo qemu-system-x86_64 haiku-vm.img
</code></pre></div></div>

<h3 id="emulation">Emulation</h3>
<p>For emulation a sdhci-pci device</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>qemu-img create sd-card.img 10G
qemu-system-x86_64 haiku-vm.img  -drive if=sd,index=0,file=sd-card.img,id=mydrive -device sdhci-pci 
</code></pre></div></div>

<h2 id="creating-device-driver">Creating Device Driver</h2>
<p>I have referred device manager doc as it mentions following things:</p>
<ul>
  <li>The object device_node describes the functionality and also specification of the device
device_node has modules and attributes. The node must have a module and other components are optional.</li>
  <li>When the system starts only a root node gets registered. The root node has hardware bus like PCI.
root node( PCI bus)-&gt; parent node(devices on PCI bus)-&gt; child node(specific to device and attach functionalities specific to device)</li>
  <li>Whenever a device is attached to PCI bus, it registers a child node for each device on the bus
For exploring the hardware in the computer, the system has device drivers.</li>
  <li>Now according to the system commands, the system will scan for the driver that provides that functionality.</li>
</ul>

<h3 id="apis-implemented-so-far">APIs implemented so far:</h3>
<ul>
  <li>supports_device(): It actually checks if the device belongs to PCI bus and filter out for sdhci-pci device out of all the devices on the pci bus.</li>
  <li>init_device(): it creates a private data structure(device_cookie) for uninit_driver(), register_child_devices(), rescan_child_devices(), device_removed(), suspend() and resume().</li>
</ul>

<h3 id="to-make-the-driver-module-loadable">To make the driver module loadable:</h3>
<ul>
  <li>Module name must end with driver_v1(SDHCI_PCI_DEVICE_MODULE_NAME “busses/mmc/sdhci_pci/driver/v1”)</li>
  <li>
    <p>Declaring module dependancy array(module_dependency module_dependencies[] = { { B_DEVICE_MANAGER_MODULE_NAME, (module_info**)&amp;gDeviceManager }, {}};)</p>
  </li>
  <li>Declaring structure for driver module info</li>
</ul>

<h2 id="loading-the-module">Loading the module</h2>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jam -q sdhci_pci will create a binary in 

generated.x86_64/objects/haiku/x86_64/release/add-ons/kernel/busses/sdhci You have to place it in 

config/non-packaged/add-ons/kernel/busses/mmc  After rebooting you can check debug messages in

cat /var/log/syslog | grep sdhci_pci Now I am working on finding out number of slots and registering them as child devices with their base adresses.   I have been updating the code on my remote github repo[1] almost everyday, feel free to review it :). Thanks!
</code></pre></div></div>

<ul>
  <li>https://github.com/krish-iyer/haiku/tree/sdhci_mmc_driver</li>
</ul>



    </main><footer>
  
</footer>
</div>
  </body>
</html>
